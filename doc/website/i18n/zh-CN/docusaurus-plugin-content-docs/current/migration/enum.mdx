---
title: Using Postgres Enum Types in Ent Schema
id: enum
slug: enum-types
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import InstallationInstructions from '../components/_installation_instructions.mdx';

枚举类型是由预定义有序值集合构成的数据结构。默认情况下，在Ent模式中使用`field.Enum`时，Ent会使用简单的字符串类型来表示**PostgreSQL和SQLite**中的枚举值。但在某些场景下，您可能需要使用数据库原生的枚举类型。

本指南将阐述如何定义使用PostgreSQL原生枚举类型的模式字段，并通过Atlas配置模式迁移，将Postgres枚举与Ent模式作为单一迁移单元进行管理。

:::info[[Atlas Pro功能](https://atlasgo.io/features#pro-plan)]
本指南中使用的[复合模式](https://atlasgo.io/atlas-schema/projects#data-source-composite_schema)支持是Pro版专属功能。使用前请执行：
```
atlas login
```
:::

## 安装Atlas

<InstallationInstructions />

## 登录Atlas

```shell
$ atlas login a8m
//highlight-next-line-info
You are now connected to "a8m" on Atlas Cloud.
```

## 复合模式

`ent/schema`包主要用于定义Ent类型（对象）、字段、边及业务逻辑。外部枚举类型或其他数据库对象在Ent模型中并无直接体现——Postgres枚举类型只需在数据库模式中定义一次，即可在多个字段和模型中复用。

为扩展PostgreSQL模式使其同时包含自定义枚举类型和Ent类型，我们需配置Atlas从[复合模式](https://atlasgo.io/atlas-schema/projects#data-source-composite_schema)数据源读取模式状态。请按以下步骤配置项目：

1\. 创建`schema.sql`定义枚举类型（也可使用[Atlas Schema HCL语言](https://atlasgo.io/atlas-schema/hcl-types#enum)定义）：

<Tabs>
<TabItem value={"sql"} label={"Using SQL"}>

```sql title="schema.sql"
CREATE TYPE status AS ENUM ('active', 'inactive', 'pending');
```

</TabItem>
<TabItem value={"hcl"} label={"Using HCL"}>

```hcl title="schema.hcl"
schema "public" {}

enum "status" {
  schema = schema.public
  values = ["active", "inactive", "pending"]
}
```

</TabItem>
</Tabs>

2\. 在Ent模式中定义使用底层Postgres `ENUM`类型的枚举字段：

```go title="ent/schema/user.go" {6-8}
// Fields of the User.
func (User) Fields() []ent.Field {
	return []ent.Field{
		field.Enum("status").
			Values("active", "inactive", "pending").
			SchemaType(map[string]string{
				dialect.Postgres: "status",
			}),
	}
}
```

:::note
当包含驱动特定类型的模式用于其他数据库时，Ent将回退到驱动默认类型（如SQLite中的`TEXT`，MariaDB/MySQL中的`ENUM(...)`）。
:::

3\. 创建`atlas.hcl`配置文件，通过`composite_schema`同时包含`schema.sql`定义的自定义枚举类型和Ent模式：

```hcl title="atlas.hcl"
data "composite_schema" "app" {
  # Load first custom types first.
  schema "public" {
    url = "file://schema.sql"
  }
  # Second, load the Ent schema.
  schema "public" {
    url = "ent://ent/schema"
  }
}

env "local" {
  src = data.composite_schema.app.url
  dev = "docker://postgres/15/dev?search_path=public"
}
```

## 使用指南

配置复合模式后，可通过`atlas schema inspect`命令获取其表示形式，生成模式迁移文件并应用到数据库等。以下是Atlas的入门命令：

#### 检查模式

`atlas schema inspect`命令通常用于检查数据库，也可用于检查`composite_schema`并输出其SQL表示：

```shell
atlas schema inspect \
  --env local \
  --url env://src \
  --format '{{ sql . }}'
```

该命令输出如下SQL，注意`status`枚举类型在模式中的定义位置优先于其在`users.status`列中的使用：

```sql
-- Create enum type "status"
CREATE TYPE "status" AS ENUM ('active', 'inactive', 'pending');
-- Create "users" table
CREATE TABLE "users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "status" "status" NOT NULL, PRIMARY KEY ("id"));
```

#### 生成模式迁移

执行以下命令生成模式迁移文件：

```shell
atlas migrate diff \
  --env local
```

生成的迁移文件内容如下：

```sql title="migrations/20240712090543.sql"
-- Create enum type "status"
CREATE TYPE "status" AS ENUM ('active', 'inactive', 'pending');
-- Create "users" table
CREATE TABLE "users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "status" "status" NOT NULL, PRIMARY KEY ("id"));
```

#### 应用迁移

执行以下命令将迁移应用到数据库：

```
atlas migrate apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable"
```

:::info[直接向数据库应用模式]

有时需要直接将模式应用到数据库而不生成迁移文件，例如在测试模式变更或启动测试数据库时。此时可使用以下命令直接将模式应用到数据库：

```shell
atlas schema apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable"
```

或使用 [Atlas Go SDK](https://github.com/ariga/atlas-go-sdk)：

```go
ac, err := atlasexec.NewClient(".", "atlas")
if err != nil {
	log.Fatalf("初始化客户端失败: %w", err)
}
// 自动用目标模式更新数据库
// 另一种方式是手动使用 'migrate apply' 或 'schema apply'
if _, err := ac.SchemaApply(ctx, &atlasexec.SchemaApplyParams{
	Env: "local",
	URL: "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable",
	AutoApprove: true,
}); err != nil {
    log.Fatalf("应用模式变更失败: %w", err)
}
```

:::

本指南代码可在 [GitHub](https://github.com/ent/ent/tree/master/examples/enumtypes) 获取。