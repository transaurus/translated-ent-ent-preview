---
title: Using Domain Types in Ent Schema
id: domain
slug: domain-types
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import InstallationInstructions from '../components/_installation_instructions.mdx';

PostgreSQL域类型是用户自定义的数据类型，它们扩展了现有类型，允许您添加约束以限制其可持有的值。将字段类型设置为域类型，可以在数据库级别强制执行数据完整性和验证规则。

本指南将说明如何在Ent模式中将字段类型定义为域类型，并配置模式迁移以使用Atlas将域和Ent模式作为单个迁移单元进行管理。

:::info[[Atlas Pro功能](https://atlasgo.io/features#pro-plan)]
Atlas对[域类型](https://atlasgo.io/atlas-schema/hcl#domain)的支持仅限Pro用户使用。
要使用此功能，请运行：
```
atlas login
```
:::

## 安装Atlas

<InstallationInstructions />

## 登录Atlas

```shell
$ atlas login a8m
//highlight-next-line-info
You are now connected to "a8m" on Atlas Cloud.
```

## 复合模式

`ent/schema`包主要用于定义Ent类型（对象）、它们的字段、边和逻辑。域类型或其他数据库对象在Ent模型中没有表示——一个域类型可以定义一次，并可以在不同的字段和模型中多次使用。

为了扩展我们的PostgreSQL模式以包括自定义域类型和Ent类型，我们配置Atlas从[复合模式](https://atlasgo.io/atlas-schema/projects#data-source-composite_schema)数据源读取模式状态。按照以下步骤为您的项目配置此功能：

1\. 创建一个`schema.sql`文件，定义必要的域类型。同样，您可以在[Atlas Schema HCL语言](https://atlasgo.io/atlas-schema/hcl-types#domain)中配置域类型：

<Tabs>
<TabItem value={"sql"} label={"Using SQL"}>

```sql title="schema.sql"
CREATE DOMAIN us_postal_code AS TEXT
CHECK(
   VALUE ~ '^\d{5}$'
   OR VALUE ~ '^\d{5}-\d{4}$'
);
```

</TabItem>
<TabItem value={"hcl"} label={"Using HCL"}>

```hcl title="schema.hcl"
schema "public" {}

domain "us_postal_code" {
  schema = schema.public
  type   = text
  null   = true
  check "us_postal_code_check" {
    expr = "((VALUE ~ '^\\d{5}$'::text) OR (VALUE ~ '^\\d{5}-\\d{4}$'::text))"
  }
}
```

</TabItem>
</Tabs>

2\. 在您的Ent模式中，定义一个仅在PostgreSQL方言中使用域类型的字段：

```go title="ent/schema/user.go" {5-7}
// Fields of the User.
func (User) Fields() []ent.Field {
	return []ent.Field{
		field.String("postal_code").
			SchemaType(map[string]string{
				dialect.Postgres: "us_postal_code",
			}),
	}
}
```

:::note
如果带有自定义驱动特定类型的模式与其他数据库一起使用，Ent将回退到驱动使用的默认类型（例如，"varchar"）。
:::

3\. 创建一个简单的`atlas.hcl`配置文件，其中包含一个`composite_schema`，该模式包括在`schema.sql`中定义的自定义类型和您的Ent模式：

```hcl title="atlas.hcl"
data "composite_schema" "app" {
  # Load first custom types first.
  schema "public" {
    url = "file://schema.sql"
  }
  # Second, load the Ent schema.
  schema "public" {
    url = "ent://ent/schema"
  }
}

env "local" {
  src = data.composite_schema.app.url
  dev = "docker://postgres/15/dev?search_path=public"
}
```

## 使用

设置好我们的模式后，我们可以使用`atlas schema inspect`命令获取其表示，为其生成迁移，将其应用到数据库等。以下是一些命令，帮助您开始使用Atlas：

#### 检查模式

`atlas schema inspect`命令通常用于检查数据库。然而，我们也可以使用它来检查我们的`composite_schema`并打印其SQL表示：

```shell
atlas schema inspect \
  --env local \
  --url env://src \
  --format '{{ sql . }}'
```

上述命令打印以下SQL。请注意，`us_postal_code`域类型在`postal_code`字段使用之前已在模式中定义：

```sql
-- Create domain type "us_postal_code"
CREATE DOMAIN "us_postal_code" AS text CONSTRAINT "us_postal_code_check" CHECK ((VALUE ~ '^\d{5}$'::text) OR (VALUE ~ '^\d{5}-\d{4}$'::text));
-- Create "users" table
CREATE TABLE "users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "postal_code" "us_postal_code" NOT NULL, PRIMARY KEY ("id"));
```

#### 为模式生成迁移

要为模式生成迁移，请运行以下命令：

```shell
atlas migrate diff \
  --env local
```

请注意，将创建一个新的迁移文件，其内容如下：

```sql title="migrations/20240712090543.sql"
-- Create domain type "us_postal_code"
CREATE DOMAIN "us_postal_code" AS text CONSTRAINT "us_postal_code_check" CHECK ((VALUE ~ '^\d{5}$'::text) OR (VALUE ~ '^\d{5}-\d{4}$'::text));
-- Create "users" table
CREATE TABLE "users" ("id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "postal_code" "us_postal_code" NOT NULL, PRIMARY KEY ("id"));
```

#### 应用迁移

要将上述生成的迁移应用到数据库，请运行以下命令：

```
atlas migrate apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable"
```

:::info[直接向数据库应用模式]

有时需要直接将模式应用到数据库而无需生成迁移文件，例如在测试模式变更或启动测试数据库时。此时可使用以下命令直接将模式应用到数据库：

```shell
atlas schema apply \
  --env local \
  --url "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable"
```

或使用 [Atlas Go SDK](https://github.com/ariga/atlas-go-sdk)：

```go
ac, err := atlasexec.NewClient(".", "atlas")
if err != nil {
	log.Fatalf("初始化客户端失败: %w", err)
}
// 自动用目标模式更新数据库
// 另一种选择是手动使用 'migrate apply' 或 'schema apply'
if _, err := ac.SchemaApply(ctx, &atlasexec.SchemaApplyParams{
	Env: "local",
	URL: "postgres://postgres:pass@localhost:5432/database?search_path=public&sslmode=disable",
	AutoApprove: true,
}); err != nil {
    log.Fatalf("应用模式变更失败: %w", err)
}
```

:::

本指南的完整代码可在 [GitHub](https://github.com/ent/ent/tree/master/examples/domaintypes) 查看。