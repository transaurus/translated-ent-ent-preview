---
title: Announcing entcache - a Cache Driver for Ent
author: Ariel Mashraki
authorURL: "https://github.com/a8m"
authorImageURL: "https://avatars0.githubusercontent.com/u/7413593"
authorTwitter: arielmashraki
---

åœ¨å¼€å‘[Ariga](https://ariga.io)çš„è¿è¥æ•°æ®å›¾è°±æŸ¥è¯¢å¼•æ“æ—¶ï¼Œæˆ‘ä»¬å‘ç°é€šè¿‡æ„å»ºå¥å£®çš„ç¼“å­˜åº“å¯ä»¥æ˜¾è‘—æå‡ä¼—å¤šåœºæ™¯çš„æ€§èƒ½ã€‚ä½œä¸ºEntçš„é‡åº¦ä½¿ç”¨è€…ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶åœ°å°†è¿™ä¸€å±‚å®ç°ä¸ºEntçš„æ‰©å±•ã€‚æœ¬æ–‡å°†ç®€è¦è§£é‡Šç¼“å­˜çš„æ¦‚å¿µã€å…¶åœ¨è½¯ä»¶æ¶æ„ä¸­çš„ä½œç”¨ï¼Œå¹¶ä»‹ç»`entcache`â€”â€”ä¸€ä¸ªä¸“ä¸ºEntè®¾è®¡çš„ç¼“å­˜é©±åŠ¨ã€‚

ç¼“å­˜æ˜¯æå‡åº”ç”¨æ€§èƒ½çš„å¸¸ç”¨ç­–ç•¥ï¼Œå…¶æ ¸å¿ƒåŸç†åœ¨äºä¸åŒä»‹è´¨çš„æ•°æ®è¯»å–é€Ÿåº¦å­˜åœ¨æ•°é‡çº§å·®å¼‚ã€‚[Jeff Dean](https://twitter.com/jeffdean?lang=en)åœ¨å…¶å…³äº"[æ„å»ºå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„è½¯ä»¶å·¥ç¨‹å»ºè®®](http://static.googleusercontent.com/media/research.google.com/en/us/people/jeff/stanford-295-talk.pdf)"çš„è‘—åæ¼”è®²ä¸­ï¼Œæ›¾ç»™å‡ºä»¥ä¸‹ç»å…¸æ•°æ®ï¼š

![ç¼“å­˜æ€§èƒ½å¯¹æ¯”](https://entgo.io/images/assets/entcache/cache-numbers.png)

è¿™äº›æ•°æ®å°è¯äº†èµ„æ·±å·¥ç¨‹å¸ˆçš„ç›´è§‰è®¤çŸ¥ï¼šå†…å­˜è¯»å–å¿«äºç£ç›˜è®¿é—®ï¼ŒåŒæ•°æ®ä¸­å¿ƒçš„æ•°æ®è·å–å¿«äºäº’è”ç½‘è¯·æ±‚ã€‚æˆ‘ä»¬è¿˜éœ€è¡¥å……çš„æ˜¯ï¼ŒæŸäº›è®¡ç®—è¿‡ç¨‹ä»£ä»·é«˜æ˜‚ä¸”è€—æ—¶ï¼Œè·å–é¢„è®¡ç®—ç»“æœå¾€å¾€æ¯”å®æ—¶é‡å¤è®¡ç®—æ›´ä¸ºé«˜æ•ˆï¼ˆä¸”æˆæœ¬æ›´ä½ï¼‰ã€‚

æ ¹æ®[ç»´åŸºç™¾ç§‘](https://en.wikipedia.org/wiki/Cache_(computing))çš„å®šä¹‰ï¼Œç¼“å­˜æ˜¯"å­˜å‚¨æ•°æ®ä»¥ä¾¿æœªæ¥è¯·æ±‚èƒ½æ›´å¿«å“åº”çš„ç¡¬ä»¶æˆ–è½¯ä»¶ç»„ä»¶"ã€‚æ¢è¨€ä¹‹ï¼Œè‹¥èƒ½å°†æŸ¥è¯¢ç»“æœæš‚å­˜äºå†…å­˜ä¸­ï¼Œå…¶å“åº”é€Ÿåº¦å°†è¿œè¶…ä»¥ä¸‹æµç¨‹ï¼šé€šè¿‡ç½‘ç»œè®¿é—®æ•°æ®åº“â†’ç£ç›˜è¯»å–â†’æ‰§è¡Œè®¡ç®—â†’ç»“æœå›ä¼ ï¼ˆä»éœ€ç»è¿‡ç½‘ç»œï¼‰ã€‚

ä½†ä½œä¸ºå·¥ç¨‹å¸ˆéœ€è°¨è®°ï¼šç¼“å­˜æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­è‘—åçš„å¤æ‚è¯¾é¢˜ã€‚æ­£å¦‚æ—©æœŸç½‘æ™¯å·¥ç¨‹å¸ˆ[Phil Karlton](https://martinfowler.com/bliki/TwoHardThings.html)çš„åè¨€ï¼š"è®¡ç®—æœºç§‘å­¦åªæœ‰ä¸¤å¤§éš¾é¢˜ï¼šç¼“å­˜å¤±æ•ˆå’Œå‘½åè§„èŒƒ"ã€‚ä¾‹å¦‚åœ¨å¼ºä¸€è‡´æ€§ç³»ç»Ÿä¸­ï¼Œé™ˆæ—§çš„ç¼“å­˜æ¡ç›®å¯èƒ½å¯¼è‡´ç³»ç»Ÿè¡Œä¸ºå¼‚å¸¸ã€‚å› æ­¤åœ¨æ¶æ„è®¾è®¡ä¸­å¼•å…¥ç¼“å­˜æ—¶ï¼Œå¿…é¡»å®¡æ…è€ƒè™‘æ¯ä¸ªç»†èŠ‚ã€‚

### ä»‹ç»`entcache`

`entcache`åŒ…æä¾›äº†å¯åŒ…è£…ç°æœ‰Ent SQLé©±åŠ¨çš„æ–°é©±åŠ¨ã€‚å…¶é«˜å±‚é€»è¾‘æ˜¯å¯¹åŸºç¡€é©±åŠ¨çš„Queryæ–¹æ³•è¿›è¡Œè£…é¥°ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶ï¼š

1. æ ¹æ®å‚æ•°ï¼ˆè¯­å¥å’Œå‚æ•°ï¼‰ç”Ÿæˆç¼“å­˜é”®ï¼ˆå³å“ˆå¸Œå€¼ï¼‰

2. æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å·²æœ‰è¯¥æŸ¥è¯¢ç»“æœï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ã€‚è‹¥å­˜åœ¨åˆ™ç›´æ¥è¿”å›å†…å­˜ç»“æœï¼Œè·³è¿‡æ•°æ®åº“è®¿é—®

3. è‹¥ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å°†æŸ¥è¯¢ä¼ é€’ç»™åº•å±‚æ•°æ®åº“æ‰§è¡Œ

4. æŸ¥è¯¢æ‰§è¡Œåï¼Œé©±åŠ¨ä¼šè®°å½•è¿”å›è¡Œ(`sql.Rows`)çš„åŸå§‹å€¼ï¼Œå¹¶ä½¿ç”¨ç”Ÿæˆçš„ç¼“å­˜é”®å°†å…¶å­˜å…¥ç¼“å­˜

è¯¥åŒ…æä¾›å¤šç§é…ç½®é€‰é¡¹ï¼šç¼“å­˜æ¡ç›®çš„TTLè®¾ç½®ã€å“ˆå¸Œå‡½æ•°æ§åˆ¶ã€è‡ªå®šä¹‰å¤šçº§ç¼“å­˜å­˜å‚¨ã€ç¼“å­˜æ¡ç›®é©±é€ä¸è·³è¿‡æœºåˆ¶ç­‰ã€‚å®Œæ•´æ–‡æ¡£å‚è§[https://pkg.go.dev/ariga.io/entcache](https://pkg.go.dev/ariga.io/entcache)ã€‚

å¦‚å‰æ‰€è¿°ï¼Œæ­£ç¡®é…ç½®åº”ç”¨ç¼“å­˜æ˜¯ç²¾ç»†å·¥ä½œï¼Œå› æ­¤`entcache`ä¸ºå¼€å‘è€…æä¾›äº†å¤šç§å¯æ­é…ä½¿ç”¨çš„ç¼“å­˜å±‚çº§ï¼š

1. åŸºäº `context.Context` çš„ç¼“å­˜ã€‚é€šå¸¸é™„åŠ åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä¸ä¸å…¶ä»–ç¼“å­˜å±‚çº§è”åŠ¨ã€‚
   ç”¨äºæ¶ˆé™¤åŒä¸€è¯·æ±‚å†…é‡å¤æ‰§è¡Œçš„æŸ¥è¯¢ã€‚

2. ç”± `ent.Client` ä½¿ç”¨çš„é©±åŠ¨çº§ç¼“å­˜ã€‚åº”ç”¨é€šå¸¸æ¯ä¸ªæ•°æ®åº“åˆ›å»ºä¸€ä¸ªé©±åŠ¨ï¼Œ
   å› æ­¤æˆ‘ä»¬å°†å…¶è§†ä¸ºè¿›ç¨‹çº§ç¼“å­˜ã€‚

3. è¿œç¨‹ç¼“å­˜ã€‚ä¾‹å¦‚ Redis æ•°æ®åº“ï¼Œä¸ºå¤šä¸ªè¿›ç¨‹æä¾›æŒä¹…åŒ–ç¼“å­˜å­˜å‚¨å’Œå…±äº«ã€‚
   è¿œç¨‹ç¼“å­˜å±‚èƒ½æŠµå¾¡åº”ç”¨éƒ¨ç½²å˜æ›´æˆ–æ•…éšœï¼Œå¹¶å‡å°‘ä¸åŒè¿›ç¨‹å¯¹æ•°æ®åº“æ‰§è¡Œçš„ç›¸åŒæŸ¥è¯¢ã€‚

4. ç¼“å­˜å±‚æ¬¡ç»“æ„æˆ–å¤šçº§ç¼“å­˜ï¼Œå…è®¸ä»¥åˆ†å±‚æ–¹å¼ç»„ç»‡ç¼“å­˜ã€‚ç¼“å­˜å­˜å‚¨çš„å±‚çº§ä¸»è¦åŸºäºè®¿é—®é€Ÿåº¦å’Œç¼“å­˜å¤§å°ã€‚
   ä¾‹å¦‚ç”±åº”ç”¨å†…å­˜ä¸­çš„ LRU ç¼“å­˜å’Œ Redis è¿œç¨‹ç¼“å­˜ç»„æˆçš„äºŒçº§ç¼“å­˜ã€‚

è®©æˆ‘ä»¬é€šè¿‡è§£é‡ŠåŸºäº `context.Context` çš„ç¼“å­˜æ¥æ¼”ç¤ºè¿™ä¸€ç‚¹ã€‚

### ä¸Šä¸‹æ–‡çº§ç¼“å­˜

`ContextLevel` é€‰é¡¹é…ç½®é©±åŠ¨ä½¿ç”¨ `context.Context` çº§ç¼“å­˜ã€‚ä¸Šä¸‹æ–‡é€šå¸¸é™„åŠ åˆ°è¯·æ±‚ï¼ˆå¦‚ `*http.Request`ï¼‰ï¼Œåœ¨å¤šçº§æ¨¡å¼ä¸‹ä¸å¯ç”¨ã€‚
å½“è¯¥é€‰é¡¹ä½œä¸ºç¼“å­˜å­˜å‚¨æ—¶ï¼Œé™„åŠ çš„ `context.Context` æºå¸¦ä¸€ä¸ª LRU ç¼“å­˜ï¼ˆå¯é…ç½®ä¸ºå…¶ä»–ç±»å‹ï¼‰ï¼Œé©±åŠ¨åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶ä¼šåœ¨è¯¥ LRU ç¼“å­˜ä¸­å­˜å‚¨å’Œæ£€ç´¢æ¡ç›®ã€‚

æ­¤é€‰é¡¹éå¸¸é€‚åˆéœ€è¦å¼ºä¸€è‡´æ€§ã€ä½†ä»å¸Œæœ›é¿å…åŒä¸€è¯·æ±‚å†…é‡å¤æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢çš„åº”ç”¨ã€‚ä¾‹å¦‚ä»¥ä¸‹ GraphQL æŸ¥è¯¢ï¼š

```graphql
query($ids: [ID!]!) {
    nodes(ids: $ids) {
        ... on User {
            id
            name
            todos {
                id
                owner {
                    id
                    name
                }
            }
        }
    }
}
```

ä¸Šè¿°æŸ¥è¯¢çš„æœ´ç´ è§£ææ–¹æ¡ˆä¼šæ‰§è¡Œï¼š1 æ¬¡æŸ¥è¯¢è·å– N ä¸ªç”¨æˆ·ï¼ŒN æ¬¡æŸ¥è¯¢è·å–æ¯ä¸ªç”¨æˆ·çš„å¾…åŠäº‹é¡¹ï¼Œ
ä»¥åŠæ¯ä¸ªå¾…åŠäº‹é¡¹å„ 1 æ¬¡æŸ¥è¯¢è·å–å…¶æ‰€æœ‰è€…ï¼ˆè¯¦è§ [_N+1 é—®é¢˜_](https://entgo.io/docs/tutorial-todo-gql-field-collection/#problem)ï¼‰ã€‚

ä½† Ent æä¾›äº†ç‹¬ç‰¹çš„è§£ææ–¹æ¡ˆï¼ˆè¯¦è§ [Ent å®˜ç½‘](https://entgo.io/docs/tutorial-todo-gql-field-collection)ï¼‰ï¼Œ
å› æ­¤æœ¬ä¾‹åªéœ€æ‰§è¡Œ 3 æ¬¡æŸ¥è¯¢ï¼š1 æ¬¡è·å– N ä¸ªç”¨æˆ·ï¼Œ1 æ¬¡è·å–**æ‰€æœ‰**ç”¨æˆ·çš„å¾…åŠäº‹é¡¹ï¼Œ1 æ¬¡è·å–**æ‰€æœ‰**å¾…åŠäº‹é¡¹çš„æ‰€æœ‰è€…ã€‚

ä½¿ç”¨ `entcache` åï¼ŒæŸ¥è¯¢æ¬¡æ•°å¯é™è‡³ 2 æ¬¡ï¼Œå› ä¸ºé¦–å°¾æŸ¥è¯¢æ˜¯ç›¸åŒçš„ï¼ˆå‚è§ [ä»£ç ç¤ºä¾‹](https://github.com/ariga/entcache/blob/master/internal/examples/ctxlevel/main_test.go)ï¼‰ã€‚

![ä¸Šä¸‹æ–‡çº§ç¼“å­˜](https://entgo.io/images/assets/entcache/ctxlevel.png)

å„å±‚çº§çš„è¯¦ç»†è¯´æ˜è§ä»“åº“ [README](https://github.com/ariga/entcache/blob/master/README.md)ã€‚

### å¿«é€Ÿå¼€å§‹

> è‹¥æ‚¨ä¸ç†Ÿæ‚‰å¦‚ä½•æ–°å»º Ent é¡¹ç›®ï¼Œè¯·å…ˆå®Œæˆ Ent [å…¥é—¨æ•™ç¨‹](https://entgo.io/docs/tutorial-setup)ã€‚

é¦–å…ˆé€šè¿‡ä»¥ä¸‹å‘½ä»¤ `go get` å®‰è£…åŒ…ã€‚

```shell
go get ariga.io/entcache
```

å®‰è£… `entcache` åï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç ç‰‡æ®µè½»æ¾é›†æˆåˆ°é¡¹ç›®ä¸­ï¼š

```go
// Open the database connection.
db, err := sql.Open(dialect.SQLite, "file:ent?mode=memory&cache=shared&_fk=1")
if err != nil {
	log.Fatal("opening database", err)
}
// Decorates the sql.Driver with entcache.Driver.
drv := entcache.NewDriver(db)
// Create an ent.Client.
client := ent.NewClient(ent.Driver(drv))

// Tell the entcache.Driver to skip the caching layer
// when running the schema migration.
if client.Schema.Create(entcache.Skip(ctx)); err != nil {
	log.Fatal("running schema migration", err)
}

// Run queries.
if u, err := client.User.Get(ctx, id); err != nil {
	log.Fatal("querying user", err)
}
// The query below is cached.
if u, err := client.User.Get(ctx, id); err != nil {
	log.Fatal("querying user", err)
}
```

æ›´å¤šé«˜çº§ç¤ºä¾‹è¯·å‚è§ä»“åº“çš„ [examples ç›®å½•](https://github.com/ariga/entcache/tree/master/internal/examples)ã€‚

### æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†æˆ‘åœ¨å¼€å‘ [Ariga è¿è¥æ•°æ®å›¾è°±](https://ariga.io) æŸ¥è¯¢å¼•æ“æ—¶åˆ›å»ºçš„ Ent ç¼“å­˜é©±åŠ¨ "entcache"ã€‚
æˆ‘ä»¬é¦–å…ˆç®€è¿°äº†åœ¨è½¯ä»¶ç³»ç»Ÿä¸­å¼•å…¥ç¼“å­˜çš„åŠ¨æœºï¼Œéšåæè¿°äº† `entcache` çš„ç‰¹æ€§å’Œèƒ½åŠ›ï¼Œæœ€åæ¼”ç¤ºäº†å¦‚ä½•åœ¨åº”ç”¨ä¸­å¿«é€Ÿé›†æˆã€‚

ç›®å‰æˆ‘ä»¬æ­£åœ¨å¼€å‘ä¸€äº›åŠŸèƒ½ï¼Œå¹¶å¸Œæœ›ç»§ç»­æ¨è¿›ï¼Œä½†éœ€è¦ç¤¾åŒºååŠ©è¿›è¡Œåˆç†è®¾è®¡ï¼ˆæ¯”å¦‚ç¼“å­˜å¤±æ•ˆé—®é¢˜ï¼Œæœ‰äººæ„Ÿå…´è¶£å—ï¼ŸğŸ˜‰ï¼‰ã€‚å¦‚æœæ‚¨æœ‰æ„å‚ä¸è´¡çŒ®ï¼Œæ¬¢è¿é€šè¿‡Entçš„Slacké¢‘é“è”ç³»æˆ‘ã€‚

:::note[è·å–æ›´å¤šEntèµ„è®¯ä¸æ›´æ–°ï¼š]

- è®¢é˜…æˆ‘ä»¬çš„[æ–°é—»é€šè®¯](https://entgo.substack.com/)
- å…³æ³¨æˆ‘ä»¬çš„[Twitter](https://twitter.com/entgo_io)
- åŠ å…¥[Gophers Slack](https://entgo.io/docs/slack)çš„#enté¢‘é“
- åŠ å…¥[Ent DiscordæœåŠ¡å™¨](https://discord.gg/qZmPgTE6RX)

:::